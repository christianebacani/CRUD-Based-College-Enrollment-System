<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Enrollment System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=8.0">
    <script src="{{ url_for('static', filename='js/main.js') }}?v=7.0" defer></script>
</head>
<body class="dashboard-page">
    <!-- Hover zone on left edge to trigger toggle button -->
    <div class="hover-zone-left"></div>
    
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='batstateu-logo.png') }}" alt="BatStateU Logo" class="navbar-logo">
            <span class="title">Student Enrollment System</span>
        </div>
        <div class="navbar-user">
            <span class="welcome-text">Welcome, <strong>{{ user.first_name }}</strong></span>
            <span class="role-badge">{{ user.role }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" id="flash-message">
                        {{ message }}
                        <button onclick="this.parentElement.remove()" class="alert-close">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container dashboard-container">
        {% if user.role == 'admin' %}
        <!-- Floating toggle button when form is collapsed -->
        <button type="button" class="floating-toggle-btn" id="floatingToggleBtn" title="Show student form">
            <span class="toggle-icon"></span>
        </button>
        
        <div class="form-panel" id="formPanel">
            <div class="panel-header">
                <h2>Student Information</h2>
            </div>
            <div class="panel-body">
                <form id="studentForm">
                    <input type="hidden" id="originalStudentId" value="">
                    
                    <div class="form-group">
                        <label for="student_id">Student ID *</label>
                        <input type="text" id="student_id" class="form-control" 
                               placeholder="e.g., 25-00916" pattern="\d{2}-\d{5}" 
                               title="Format: YY-NNNNN (e.g., 25-00916)" 
                               maxlength="8" required>
                    </div>

                    <div class="form-group">
                        <label for="first_name">First Name *</label>
                        <input type="text" id="first_name" class="form-control" 
                               placeholder="First name" pattern="[a-zA-Z\s'-]+" 
                               title="Only letters, spaces, hyphens, and apostrophes allowed" 
                               minlength="2" maxlength="50" required>
                    </div>

                    <div class="form-group">
                        <label for="middle_name">Middle Name</label>
                        <input type="text" id="middle_name" class="form-control" 
                               placeholder="Middle name" pattern="[a-zA-Z\s'-]+" 
                               title="Only letters, spaces, hyphens, and apostrophes allowed" 
                               maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="last_name">Last Name *</label>
                        <input type="text" id="last_name" class="form-control" 
                               placeholder="Last name" pattern="[a-zA-Z\s'-]+" 
                               title="Only letters, spaces, hyphens, and apostrophes allowed" 
                               minlength="2" maxlength="50" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" class="form-control" 
                               placeholder="student@example.com" 
                               title="Enter a valid email address" 
                               maxlength="100" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone *</label>
                        <input type="tel" id="phone" class="form-control" 
                               placeholder="09XX-XXX-XXXX (e.g., 0912-345-6789)" 
                               pattern="09\d{2}-\d{3}-\d{4}" 
                               title="Phone format: 09XX-XXX-XXXX (e.g., 0912-345-6789)" 
                               maxlength="13" required>
                    </div>

                    <div class="form-group">
                        <label for="department">College Department *</label>
                        <select id="department" class="form-control" required style="white-space: normal; overflow: hidden; text-overflow: ellipsis;">
                            <option value="">Select department</option>
                            <option value="College of Engineering">College of Engineering (COE)</option>
                            <option value="College of Architecture, Fine Arts and Design">College of Architecture, Fine Arts and Design (CAFAD)</option>
                            <option value="College of Engineering Technology">College of Engineering Technology (CET)</option>
                            <option value="College of Informatics and Computing Sciences">College of Informatics and Computing Sciences (CICS)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="course">Course *</label>
                        <select id="course" class="form-control" required>
                            <option value="">Select department first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="year_level">Year Level *</label>
                        <select id="year_level" class="form-control" required>
                            <option value="">Select year level</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" class="form-control">
                            <option value="Enrolled">Enrolled</option>
                            <option value="Unenrolled">Unenrolled</option>
                            <option value="Graduated">Graduated</option>
                            <option value="Dropped">Dropped</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Transferred Out">Transferred Out</option>
                        </select>
                    </div>

                    <div class="button-group">
                        {% if user.role == 'admin' %}
                        <button type="button" onclick="addStudent()" class="btn btn-success btn-block">
                            ‚ûï Add Student
                        </button>
                        <button type="button" onclick="updateStudent()" class="btn btn-warning btn-block">
                            ‚úèÔ∏è Update Student
                        </button>
                        <button type="button" onclick="deleteStudent()" class="btn btn-danger btn-block">
                            üóëÔ∏è Delete Student
                        </button>
                        {% endif %}
                        <button type="button" onclick="clearForm()" class="btn btn-secondary btn-block">
                            üîÑ Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="table-panel">
            <div class="panel-header">
                <h2>Student Records</h2>
            </div>
            <div class="panel-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" class="form-control search-input" 
                           placeholder="üîç Search by ID, name, or course..." 
                           onkeypress="if(event.key === 'Enter') { event.preventDefault(); handleSearchOrRefresh(); this.classList.add('search-active'); setTimeout(() => this.classList.remove('search-active'), 300); }">
                </div>
                <button onclick="this.classList.add('btn-active'); setTimeout(() => this.classList.remove('btn-active'), 300); handleSearchOrRefresh();" id="searchRefreshBtn" class="btn btn-primary">üîç Search</button>
                <span class="record-count" id="recordCount">Total: 0 records</span>
            </div>
            <div class="panel-body">
                <div class="table-container">
                    <table class="data-table" id="studentsTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="id" onclick="sortTable('id')">
                                    ID <span class="sort-arrow"></span>
                                </th>
                                <th class="sortable" data-column="student_id" onclick="sortTable('student_id')">
                                    Student ID <span class="sort-arrow"></span>
                                </th>
                                <th class="sortable" data-column="name" onclick="sortTable('name')">
                                    Name <span class="sort-arrow"></span>
                                </th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th class="sortable" data-column="course" onclick="sortTable('course')">
                                    Course <span class="sort-arrow"></span>
                                </th>
                                <th class="sortable" data-column="department" onclick="sortTable('department')">
                                    <span class="dept-short">Dept.</span><span class="dept-long">Department</span> <span class="sort-arrow"></span>
                                </th>
                                <th class="sortable" data-column="year_level" onclick="sortTable('year_level')">
                                    Year <span class="sort-arrow"></span>
                                </th>
                                <th class="sortable" data-column="status" onclick="sortTable('status')">
                                    Status <span class="sort-arrow"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="9" class="loading-message">Loading students...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination-wrapper">
                    <div class="pagination-container" id="paginationContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        const userRole = "{{ user.role }}";
        
        // Course offerings by department - BatStateU Alangilan Campus
        const departmentCourses = {
            'College of Engineering': [
                'BS Chemical Engineering',
                'BS Civil Engineering',
                'BS Computer Engineering',
                'BS Electrical Engineering',
                'BS Electronics Engineering',
                'BS Industrial Engineering',
                'BS Mechanical Engineering',
                'BS Mechatronics Engineering',
                'BS Petroleum Engineering',
                'BS Sanitary Engineering'
            ],
            'College of Architecture, Fine Arts and Design': [
                'Bachelor of Science in Architecture',
                'Bachelor of Fine Arts and Design - Visual Communication'
            ],
            'College of Engineering Technology': [
                'BET Automotive Engineering Technology',
                'BET Civil Engineering Technology',
                'BET Computer Engineering Technology',
                'BET Drafting Engineering Technology',
                'BET Electrical Engineering Technology',
                'BET Electronics Engineering Technology',
                'BET Food Engineering Technology',
                'BET Instrumentation and Control Engineering Technology',
                'BET Mechanical Engineering Technology',
                'BET Mechatronics Engineering Technology',
                'BET Welding and Fabrication Engineering Technology'
            ],
            'College of Informatics and Computing Sciences': [
                'Bachelor of Science in Computer Science',
                'Bachelor of Science in Information Technology'
            ]
        };
        
        // Handle department change to populate courses
        document.getElementById('department').addEventListener('change', function() {
            const department = this.value;
            const courseSelect = document.getElementById('course');
            
            // Clear existing options
            courseSelect.innerHTML = '';
            
            if (department && departmentCourses[department]) {
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select course';
                courseSelect.appendChild(defaultOption);
                
                // Add courses for selected department
                departmentCourses[department].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseSelect.appendChild(option);
                });
                
                courseSelect.disabled = false;
            } else {
                // No department selected
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Select department first';
                courseSelect.appendChild(option);
                courseSelect.disabled = true;
            }
        });
        
        setTimeout(() => {
            const flashMessage = document.getElementById('flash-message');
            if (flashMessage) {
                flashMessage.style.opacity = '0';
                setTimeout(() => flashMessage.remove(), 300);
            }
        }, 5000);

        // Load students when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadStudents();
                setupFormHandlers();
            });
        } else {
            // DOM already loaded
            loadStudents();
            setupFormHandlers();
        }
        
        function setupFormHandlers() {
            // Prevent form submission on Enter or Tab (only for admin users)
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                studentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            // Form panel toggle functionality
            const floatingToggleBtn = document.getElementById('floatingToggleBtn');
            const formPanel = document.getElementById('formPanel');
            const dashboardContainer = document.querySelector('.dashboard-container');
            const hoverZone = document.querySelector('.hover-zone-left');
            
            if (formPanel && floatingToggleBtn) {
                // Check localStorage for saved state
                const isCollapsed = localStorage.getItem('formPanelCollapsed') === 'true';
                if (isCollapsed) {
                    formPanel.classList.add('collapsed');
                    dashboardContainer.classList.add('form-collapsed');
                }
                
                // Show button on left edge hover
                if (hoverZone) {
                    hoverZone.addEventListener('mouseenter', function() {
                        floatingToggleBtn.classList.add('visible');
                    });
                    
                    hoverZone.addEventListener('mouseleave', function(e) {
                        // Keep visible if hovering over the button itself
                        if (!floatingToggleBtn.matches(':hover')) {
                            floatingToggleBtn.classList.remove('visible');
                        }
                    });
                    
                    floatingToggleBtn.addEventListener('mouseleave', function() {
                        if (!hoverZone.matches(':hover')) {
                            floatingToggleBtn.classList.remove('visible');
                        }
                    });
                }
                
                // Toggle function
                floatingToggleBtn.addEventListener('click', function() {
                    const isCurrentlyCollapsed = formPanel.classList.toggle('collapsed');
                    dashboardContainer.classList.toggle('form-collapsed');
                    
                    // Save state to localStorage
                    localStorage.setItem('formPanelCollapsed', isCurrentlyCollapsed);
                });
            }
        }
    </script>
</body>
</html>
